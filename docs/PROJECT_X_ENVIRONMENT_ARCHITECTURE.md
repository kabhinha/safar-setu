# Project X: Environment Architecture & Migration Contract
**Version:** 2.0 (Migration & Pilot-Ready)
**Status:** AUTHORITATIVE
**Agent:** 1 (Environment & Foundation)

This document serves as the **Technical Constitution** for the Project X migration. All agents must adhere to the structures, stacks, and constraints defined here.

---

## 1. üì¶ Updated Tech Stack

### 1.1 Backend (Migration Target)
*   **Framework:** **Django 5.x** (Python 3.10+)
    *   *Rationale:* Robust built-in security, admin interface for government audit, mature ORM for complex RBAC, and strict structure compared to FastAPI.
*   **API Interface:** Django REST Framework (DRF).
*   **Async/Tasks:** Celery + Redis (for CCTV ingestion and emails).
*   **Geospatial:** GeoDjango (PostGIS) - *Internal use only for polygon fencing; NO user tracking.*

### 1.2 Frontend (Existing & Adapted)
*   **Core:** React 18+ (TypeScript) + Tailwind CSS.
*   **Build System:** Vite.
*   **Architecture:** Single Codebase, **Build-Time Mode Switching**.
    *   **Mode A (Web/Mobile):** Authenticated, full feature set.
    *   **Mode B (Kiosk):** Public, no-login, touch-optimized, restricted routes.
    *   *Implementation:* Controlled via `VITE_APP_MODE` env var.

### 1.3 Data Persistence
*   **Primary DB:** PostgreSQL 15+
    *   *Schema:* Relational (Users, Listings, Bookings).
*   **Audit Log Store:** PostgreSQL (Partitioned Table) or TimescaleDB extension.
    *   *Requirement:* Append-only, distinct from transaction tables.
*   **Cache:** Redis.

### 1.4 Auth & Security
*   **Authentication:** JWT (JSON Web Tokens) via `rest_framework_simplejwt`.
*   **Encryption:** Strong hashing (Argon2) for passwords.
*   **Secrets:** Managed via `.env` files (never committed).

---

## 2. üóÇ Migration-Aware Repository Structure

We will transition from the legacy structure to a clean Django-centric structure without losing history.

```text
/Project X (Root)
‚îÇ
‚îú‚îÄ‚îÄ .env.example                # Template for environment variables
‚îú‚îÄ‚îÄ .gitignore                  # Updated for Python/Node/Django
‚îú‚îÄ‚îÄ docker-compose.yml          # Main orchestration
‚îÇ
‚îú‚îÄ‚îÄ backend/                    # [NEW] Django Root
‚îÇ   ‚îú‚îÄ‚îÄ manage.py
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Settings (base, dev, prod)
‚îÇ   ‚îú‚îÄ‚îÄ core/                   # Shared: RBAC, Audit, Utils
‚îÇ   ‚îú‚îÄ‚îÄ users/                  # Custom User Model & Auth
‚îÇ   ‚îú‚îÄ‚îÄ listings/               # Places, Hotspots
‚îÇ   ‚îú‚îÄ‚îÄ bookings/               # Orders, Reservations
‚îÇ   ‚îú‚îÄ‚îÄ safety/                 # CCTV Aggregation, Crowd Logic
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îÇ
‚îú‚îÄ‚îÄ legacy_backend_fastapi/     # [MOVED] Old FastAPI code (Reference only)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ frontend/                   # [EXISTING] React + Tailwind
‚îÇ   ‚îú‚îÄ‚îÄ .env.kiosk              # Kiosk-specific build config
‚îÇ   ‚îú‚îÄ‚îÄ .env.web                # Web-specific build config
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/         # Shared UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ features/           # Feature slices
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.tsx            # Entry point (Mode-aware)
‚îÇ   ‚îî‚îÄ‚îÄ vite.config.ts
‚îÇ
‚îú‚îÄ‚îÄ infra/                      # Infrastructure & Deployment
‚îÇ   ‚îú‚îÄ‚îÄ postgres/
‚îÇ   ‚îú‚îÄ‚îÄ nginx/                  # Reverse proxy config
‚îÇ   ‚îî‚îÄ‚îÄ k8s/                    # Future Kubernetes manifests
‚îÇ
‚îî‚îÄ‚îÄ docs/                       # Policy & Architecture Docs
    ‚îú‚îÄ‚îÄ PROJECT_X_PRD_AND_POLICY_V2.md
    ‚îú‚îÄ‚îÄ Project_X_RBAC_and_RACI_v2.md
    ‚îî‚îÄ‚îÄ PROJECT_X_ENVIRONMENT_ARCHITECTURE.md
```

---

## 3. üîê Auth, RBAC & Security Foundations

### 3.1 JWT Token Structure (Enforced)
Payload must contain strict claims to support the RBAC v2 matrix.
```json
{
  "sub": "user_id_uuid",
  "role": "TRAVELER" | "HOST" | "MODERATOR" | "ADMIN",
  "scope": "read write",
  "geo_scope": "AS_GUWAHATI" | "ALL",  // For moderators
  "is_kiosk": false,                   // True if generated by Kiosk session
  "exp": 1234567890
}
```

### 3.2 Django Middleware Stack
Order is critical for security:
1.  `SecurityMiddleware`
2.  `SessionMiddleware`
3.  `CommonMiddleware`
4.  `CsrfViewMiddleware` (Exempt for API, strict for Admin)
5.  `AuthenticationMiddleware`
6.  `RbacEnforcementMiddleware` **[CUSTOM]**: Checks `request.user.role` against view requirements.
7.  `AuditLogMiddleware` **[CUSTOM]**: Logs all `POST/PUT/DELETE` to Audit DB.

### 3.3 Feature Flags
Implemented in `core.models.FeatureFlag`.
*   `ENABLE_PILOT_DISTRICT_{ID}` (Bool)
*   `EMERGENCY_SHUTDOWN` (Bool) - Kills all non-admin transactions instantly.
*   `KIOSK_MODE_ACTIVE` (Bool)

---

## 4. ‚öôÔ∏è Environment Variable Specification

Do **NOT** put secrets in `settings.py`. Use `python-decouple` or `environ`.

### Shared
```bash
PROJECT_ENV=dev # dev | staging | prod
SECRET_KEY=...
ALLOWED_HOSTS=...
```

### Backend (Django)
```bash
DB_NAME=projectx
DB_USER=postgres
DB_PASSWORD=...
DB_HOST=db
REDIS_URL=redis://redis:6379/0
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001
JWT_SIGNING_KEY=...
```

### Frontend (React)
```bash
VITE_API_URL=http://localhost:8000/api/v1
VITE_APP_MODE=WEB # WEB | KIOSK
VITE_MAP_STYLE_URL=... # Abstract map style only
```

---

## 5. üß± Shared Core Modules

The `backend/core` app is the foundation. It must include:

1.  **`abstract_models.py`**:
    *   `TimeStampedModel`: `created_at`, `updated_at`.
    *   `UUIDModel`: Default ID as UUID4.
2.  **`permissions.py`**: DRF Permission classes.
    *   `IsTraveler`, `IsHost`, `IsAdmin`.
    *   `IsKioskDevice` (Validates shared secret/IP for kiosk endpoints).
3.  **`audit.py`**: Service to write to the Audit Log.
    *   Function: `log_action(user, action, target, payload)`.

---

## 6. üß™ Local Dev Setup (Migration-Friendly)

### 6.1 Windows + Docker Workflow
Since this is a Windows environment, we use Docker Compose for backing services but allow local running of Django/Node for DX.

1.  **Start DB/Redis:** `docker-compose up -d db redis`
2.  **Backend:**
    *   `cd backend`
    *   `python -m venv venv`
    *   `pip install -r requirements.txt`
    *   `python manage.py runserver`
3.  **Frontend (Web/Mobile):**
    *   `cd frontend`
    *   `npm run dev` (Starts on port 3000)
4.  **Frontend (Kiosk Emulation):**
    *   `cd frontend`
    *   `npm run dev:kiosk` (Starts on port 3001 with `VITE_APP_MODE=KIOSK`)

### 6.2 Transition State
*   Keep `legacy_backend_fastapi` folder available for reference.
*   Port endpoints module-by-module (Auth -> Listings -> Bookings).
*   **Do not** attempt to run both backends on the same port.

---

## 7. ‚ùå Explicit ‚ÄúDo Not Migrate / Do Not Configure‚Äù List

1.  **NO Social Auth:** Do not install `django-allauth` social providers.
2.  **NO Google Maps:** Use Mapbox/OpenStreetMap with **custom simplified tiles** only. No routing APIs.
3.  **NO Face Recognition Libs:** Do not install `face_recognition` or OpenCV for facial logic.
4.  **NO Analytics Trackers:** Do not install Google Analytics or Facebook Pixel in Frontend.
5.  **NO "User Nearby" Geofencing:** Do not configure Redis Geo for "people near me".
6.  **NO Scraping Tools:** Do not migrate any `selenium` or `beautifulsoup` scripts from legacy research.

---

**End of Contract**
